import copy
import random
import string

import pytest

from lambdas.document_filter.document_filter_handler import (
    build_handler,
)
from tests.fixtures.s3_client import s3_client

TEST_BUCKET = "test_bucket"
UNID = "unid-12345"
RAW_KEY = "inputs/test_html.json"


# ---------------- Fixtures ---------------- #
@pytest.fixture(autouse=True)
def setup_env(monkeypatch):
    monkeypatch.setenv("MINIMUM_CHAR_LENGTH_PDF", "10")
    monkeypatch.setenv("MINIMUM_CHAR_LENGTH_HTML", "250")


@pytest.fixture
def valid_event():
    return {
        "metadata": {
            "unid": UNID,
            "region": "on",
            "province": ["ON"],
            "title": "DocTitle",
            "file_name": f"{UNID}.html",
            "url": "http://example.com",
            "subject": "Subj",
            "category": "Cat",
            "section_name": "Sec",
            "subsection_name": "Subsec",
            "language": "english",
            "status": "Published",
        },
        "raw_path": f"s3://{TEST_BUCKET}/{RAW_KEY}",
        "content_type": "html",
        "docum_region": "on",
        "region_prefix": "regions/on/",
        "extracted_text_length": 500,
        "supported_languages": ["english", "unsure"],
    }


REGION_VALIDATION_SCENARIOS = [
    # Ontario region tests
    {
        "test_id": "on_region_on_province_success",
        "description": "Ontario region with ON province - should pass",
        "docum_region": "on",
        "provinces": ["ON"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "on_region_on_atl_provinces_success",
        "description": "Ontario region with ON and ATL provinces - should pass",
        "docum_region": "on",
        "provinces": ["ON", "ATL"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "on_region_on_nb_provinces_success",
        "description": "Ontario region with ON and NB provinces - should pass",
        "docum_region": "on",
        "provinces": ["ON", "NB"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "on_region_atl_only_blocked",
        "description": "Ontario region with only ATL province - should block",
        "docum_region": "on",
        "provinces": ["ATL"],
        "expected_result": "BLOCK",
    },
    {
        "test_id": "on_region_nb_only_blocked",
        "description": "Ontario region with only NB province - should block",
        "docum_region": "on",
        "provinces": ["NB"],
        "expected_result": "BLOCK",
    },
    {
        "test_id": "on_region_west_province_blocked",
        "description": "Ontario region with WEST province - should block",
        "docum_region": "on",
        "provinces": ["BC"],
        "expected_result": "BLOCK",
    },
    # Atlantic region tests
    {
        "test_id": "atl_region_nb_province_success",
        "description": "Atlantic region with NB province - should pass",
        "docum_region": "atl",
        "provinces": ["NB"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "atl_region_on_nb_provinces_success",
        "description": "Atlantic region with ON and NB provinces - should pass",
        "docum_region": "atl",
        "provinces": ["ON", "NB"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "atl_region_on_atl_provinces_success",
        "description": "Atlantic region with ON and ATL provinces - should pass",
        "docum_region": "atl",
        "provinces": ["ON", "ATL"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "atl_region_pe_province_success",
        "description": "Atlantic region with PE province - should pass",
        "docum_region": "atl",
        "provinces": ["PE"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "atl_region_ns_province_success",
        "description": "Atlantic region with NS province - should pass",
        "docum_region": "atl",
        "provinces": ["NS"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "atl_region_nl_province_success",
        "description": "Atlantic region with NL province - should pass",
        "docum_region": "atl",
        "provinces": ["NL"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "atl_region_nf_province_success",
        "description": "Atlantic region with NF province - should pass",
        "docum_region": "atl",
        "provinces": ["NF"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "atl_region_atl_province_success",
        "description": "Atlantic region with ATL province - should pass",
        "docum_region": "atl",
        "provinces": ["ATL"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "atl_region_multiple_atl_provinces_success",
        "description": "Atlantic region with multiple ATL provinces - should pass",
        "docum_region": "atl",
        "provinces": ["NB", "PE", "NS"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "atl_region_on_only_blocked",
        "description": "Atlantic region with only ON province - should block",
        "docum_region": "atl",
        "provinces": ["ON"],
        "expected_result": "BLOCK",
    },
    {
        "test_id": "atl_region_west_province_blocked",
        "description": "Atlantic region with WEST province - should block",
        "docum_region": "atl",
        "provinces": ["BC"],
        "expected_result": "BLOCK",
    },
    # West region tests
    {
        "test_id": "west_region_bc_province_success",
        "description": "West region with BC province - should pass",
        "docum_region": "west",
        "provinces": ["BC"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "west_region_ab_province_success",
        "description": "West region with AB province - should pass",
        "docum_region": "west",
        "provinces": ["AB"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "west_region_west_province_success",
        "description": "West region with WEST province - should pass",
        "docum_region": "west",
        "provinces": ["WEST"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "west_region_ab_bc_provinces_success",
        "description": "West region with AB and BC provinces - should pass",
        "docum_region": "west",
        "provinces": ["AB", "BC"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "west_region_on_province_blocked",
        "description": "West region with ON province - should block",
        "docum_region": "west",
        "provinces": ["ON"],
        "expected_result": "BLOCK",
    },
    {
        "test_id": "west_region_atl_province_blocked",
        "description": "West region with ATL province - should block",
        "docum_region": "west",
        "provinces": ["NB"],
        "expected_result": "BLOCK",
    },
    # Quebec region tests
    {
        "test_id": "qc_region_qc_province_success",
        "description": "Quebec region with QC province - should pass",
        "docum_region": "qc",
        "provinces": ["QC"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "qc_region_on_province_blocked",
        "description": "Quebec region with ON province - should block",
        "docum_region": "qc",
        "provinces": ["ON"],
        "expected_result": "BLOCK",
    },
    {
        "test_id": "qc_region_atl_province_blocked",
        "description": "Quebec region with ATL province - should block",
        "docum_region": "qc",
        "provinces": ["ATL"],
        "expected_result": "BLOCK",
    },
    # Case insensitivity tests
    {
        "test_id": "case_insensitive_lowercase_on",
        "description": "Lowercase ON province should work - should pass",
        "docum_region": "on",
        "provinces": ["on"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "case_insensitive_mixed_atl",
        "description": "Mixed case ATL provinces should work - should pass",
        "docum_region": "atl",
        "provinces": ["Nb", "Pe"],
        "expected_result": "CONTINUE",
    },
    {
        "test_id": "case_insensitive_lowercase_west",
        "description": "Lowercase WEST provinces should work - should pass",
        "docum_region": "west",
        "provinces": ["bc", "ab"],
        "expected_result": "CONTINUE",
    },
]


def generate_random_text(length=100):
    letters = string.ascii_letters
    return "".join(random.choice(letters) for _ in range(length))


@pytest.fixture(autouse=True, scope="function")
def setup_s3(s3_client):
    small_chunk_key = "small_chunk.txt"
    large_chunk_key = "large_chunk.txt"
    small_chunk = generate_random_text(8)
    large_chunk = generate_random_text(300)
    s3_client.create_bucket(Bucket=TEST_BUCKET)
    s3_client.put_object(Bucket=TEST_BUCKET, Key=small_chunk_key, Body=small_chunk)
    s3_client.put_object(Bucket=TEST_BUCKET, Key=large_chunk_key, Body=large_chunk)


# ---------------- Tests ---------------- #
def test_region_mismatch(valid_event):
    handler = build_handler()
    event = copy.deepcopy(valid_event)
    event["docum_region"] = "qc"
    result = handler(event)
    assert result["process"] == "BLOCK"


def test_language_mismatch(valid_event):
    handler = build_handler()
    event = copy.deepcopy(valid_event)
    event["metadata"]["language"] = "french"
    # supported_languages for ON does NOT include french
    event["supported_languages"] = ["english", "unsure"]
    result = handler(event)
    assert result["process"] == "BLOCK"


def test_insufficient_length_pdf(valid_event):
    handler = build_handler()
    event = copy.deepcopy(valid_event)
    event["extracted_text_length"] = 1
    event["content_path"] = f"s3://{TEST_BUCKET}/large_chunk.txt"
    result = handler(event)
    assert result["process"] == "BLOCK"

    event["content_path"] = f"s3://{TEST_BUCKET}/small_chunk.txt"
    result = handler(event)
    assert result["process"] == "BLOCK"


def test_successful_pass(valid_event):
    handler = build_handler()
    event = copy.deepcopy(valid_event)
    event["content_path"] = f"s3://{TEST_BUCKET}/large_chunk.txt"
    result = handler(event)
    assert result["process"] == "CONTINUE"


def test_supported_language_case_insensitive(valid_event):
    handler = build_handler()
    event = copy.deepcopy(valid_event)
    event["metadata"]["language"] = "ENGLISH"
    result = handler(event)
    assert result["process"] == "CONTINUE"


def test_non_supported_language_case_insensitive(valid_event):
    handler = build_handler()
    event = copy.deepcopy(valid_event)
    event["metadata"]["language"] = "FRENCH"
    event["supported_languages"] = ["english", "unsure"]
    result = handler(event)
    assert result["process"] == "BLOCK"


def test_minimum_content_length_html(valid_event):
    handler = build_handler()
    event = copy.deepcopy(valid_event)
    event["content_type"] = "html"
    event["extracted_text_length"] = 249  # 1 less than min
    result = handler(event)
    assert result["process"] == "BLOCK"

    event["extracted_text_length"] = 250  # exactly min
    result = handler(event)
    assert result["process"] == "CONTINUE"


def test_minimum_content_length_pdf(valid_event):
    handler = build_handler()
    event = copy.deepcopy(valid_event)
    event["content_type"] = "pdf"
    event["extracted_text_length"] = 9  # 1 less than min
    result = handler(event)
    assert result["process"] == "BLOCK"

    event["extracted_text_length"] = 10  # exactly min
    result = handler(event)
    assert result["process"] == "CONTINUE"


def test_missing_required_env_vars(monkeypatch, valid_event):
    monkeypatch.delenv("MINIMUM_CHAR_LENGTH_PDF", raising=False)
    monkeypatch.delenv("MINIMUM_CHAR_LENGTH_HTML", raising=False)
    with pytest.raises(Exception):
        build_handler()


def test_missing_supported_languages_field_blocks(valid_event):
    handler = build_handler()
    event = copy.deepcopy(valid_event)
    event.pop("supported_languages", None)
    result = handler(event)
    assert result["process"] == "BLOCK"


@pytest.mark.parametrize(
    "scenario", REGION_VALIDATION_SCENARIOS, ids=lambda s: s["test_id"]
)
def test_region_validation_comprehensive(valid_event, scenario):
    """Test region validation logic with comprehensive scenarios."""
    handler = build_handler()
    event = copy.deepcopy(valid_event)

    event["metadata"]["province"] = scenario["provinces"]
    event["docum_region"] = scenario["docum_region"]

    # Keep supported_languages as ON default unless a scenario changes it
    # (Region validation happens before language validation in handler anyway)

    result = handler(event)

    assert result["process"] == scenario["expected_result"]
